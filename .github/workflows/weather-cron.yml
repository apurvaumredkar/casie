name: Daily Weather Updates

on:
  schedule:
    # Runs every hour to check if it's 7 AM in your current timezone
    # Uses UTC offset from CASIE Bridge location data for dynamic timezone calculation
    - cron: '0 * * * *' # Every hour at minute 0
  workflow_dispatch: # Allows manual triggering from Actions tab

jobs:
  send-weather-update:
    runs-on: ubuntu-latest
    steps:
      - name: Check Time and Send Weather Update
        run: |
          echo "Checking if it's 7 AM in your current timezone..."
          echo "UTC Time: $(date -u '+%Y-%m-%d %H:%M:%S %Z')"

          # Step 1: Get tunnel URL from Cloudflare KV
          echo "Fetching tunnel URL from Cloudflare KV..."
          tunnel_url=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/storage/kv/namespaces/${{ secrets.BRIDGE_KV_NAMESPACE_ID }}/values/current_tunnel_url" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" | tr -d '"')

          if [ -z "$tunnel_url" ] || [ "$tunnel_url" = "null" ]; then
            echo "‚ùå CASIE Bridge tunnel URL not found in KV"
            exit 1
          fi

          echo "Tunnel URL: $tunnel_url"

          # Step 2: Get location with UTC offset from CASIE Bridge
          echo "Fetching location data with UTC offset..."
          location_response=$(curl -s -X GET \
            "$tunnel_url/location" \
            -H "Authorization: Bearer ${{ secrets.CASIE_BRIDGE_API_TOKEN }}")

          # Extract offset from location data (in seconds)
          offset_seconds=$(echo "$location_response" | jq -r '.location.offset')

          if [ -z "$offset_seconds" ] || [ "$offset_seconds" = "null" ]; then
            echo "‚ùå Failed to get UTC offset from location data"
            echo "Location Response: $location_response"
            exit 1
          fi

          echo "UTC Offset: $offset_seconds seconds"

          # Step 3: Calculate local hour
          utc_hour=$(date -u '+%H')
          offset_hours=$(echo "$offset_seconds / 3600" | bc)
          local_hour=$(( ($utc_hour + $offset_hours) % 24 ))

          # Handle negative modulo
          if [ $local_hour -lt 0 ]; then
            local_hour=$(( $local_hour + 24 ))
          fi

          echo "UTC Hour: $utc_hour"
          echo "Offset Hours: $offset_hours"
          echo "Local Hour: $local_hour"

          # Step 4: Only send weather if it's 7 AM local time
          if [ $local_hour -ne 7 ]; then
            echo "‚è∞ Not 7 AM yet (current local hour: $local_hour). Skipping weather update."
            exit 0
          fi

          echo "‚è∞ It's 7 AM! Sending weather update..."

          # Step 5: Send weather update
          # The worker's /cron/weather endpoint:
          # 1. Fetches your current location from CASIE Bridge
          # 2. Gets weather for that location
          # 3. Sends to Discord with dynamic timestamp (shows in YOUR timezone)

          response=$(curl -s -w "\n%{http_code}" -X GET \
            "https://casie-core.apoorv-umredkar.workers.dev/cron/weather" \
            -H "Authorization: Bearer ${{ secrets.WEATHER_CRON_SECRET }}")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Status: $http_code"
          echo "Response Body: $body"

          if [ "$http_code" != "200" ]; then
            echo "‚ùå Weather update failed with status $http_code"
            exit 1
          fi

          echo "‚úÖ Weather update sent successfully!"
          echo "üìç Location detected from CASIE Bridge"
          echo "üïê Discord timestamp shows in your local timezone automatically"
